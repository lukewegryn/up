<!DOCTYPE html>
<html lang="en-US">
<head>
<link rel="stylesheet" type="text/css" href="https://opensource.keycdn.com/fontawesome/4.7.0/font-awesome.min.css" />
<link rel="stylesheet" href="css/font-awesome-animation.css">
</head>
<style>
table, th , td  {
  border: 1px solid grey;
  border-collapse: collapse;
  padding: 5px;
}
table tr:nth-child(odd) {
  background-color: #f1f1f1;
}
table tr:nth-child(even) {
  background-color: #ffffff;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.js"></script>
<script src="https://js.pusher.com/4.0/pusher.min.js"></script>

<body>

<div ng-app="myApp">

<!--<table>
  <tr ng-repeat="x in names">
    <td>{{ x.name }}</td>
    <td>{{ x.points }}</td>
  </tr>
</table>-->

<div ng-controller="navCtrl">
    <a href="#/">Main</a>
    <a ng-show="!isRegistered()" href="#login">Login</a>
    <a ng-show="isRegistered()" href="#vote">Vote</a>
    <a ng-show="isPrivileged()" href="#users">Users</a>
    <a ng-show="!isRegistered()" href="#register">Register</a>
    <a ng-show="isPrivileged()" href="#candidates">Candidates</a>
    <a ng-show="isRegistered()" href="#logout">Logout</a>
</div>

<div ng-view></div>

</div>

<script>
host = "http://localhost:3000"
var pusher = new Pusher('ba3b3cba4d81f78b5a20', {
  encrypted: true
});

    // Enable pusher logging - don't include this in production

var app = angular.module('myApp', ["ngRoute"]);

// Create the factory that share the Fact
app.factory('User', function(){
  return { username: '', privilege: 0 };
});

app.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "main.htm",
        controller : "mainCtrl"
    })
    .when("/login", {
        templateUrl : "login.htm",
        controller : "loginCtrl"
    })
    .when("/vote", {
        templateUrl : "vote.htm",
        controller : "voteCtrl"
    })
    .when("/users", {
        templateUrl : "users.htm",
        controller : "usersCtrl"
    })
    .when("/register", {
        templateUrl : "register.htm",
        controller : "registerCtrl"
    })
    .when("/candidates", {
        templateUrl : "candidates.htm",
        controller : "candidatesCtrl"
    })
    .when("/logout", {
        template : "<h3>You have been logged out.</h3>",
        controller : "logoutCtrl"
    })
});

app.controller('navCtrl', function($scope, $http, User) {

    $http.get(host + "/api/currentPrivilege")
    .then(function (response) {
        if(response.data.success !== false){
            console.log("Reloading navCtrl...")
            console.log(response.data)
            User.privilege = response.data.privilege;
            User.username = response.data.username;
        }
    });

    $scope.isRegistered = function(status) {
        if(User.privilege == 1 || User.privilege == 2){
            return true
        } else {
            return false
        }
    };
    $scope.isPrivileged = function(status) {
        if(User.privilege == 1){
            return true
        } else {
            return false
        }
    };
});

app.controller('mainCtrl', function($scope, $http, User, $route) {

});

app.controller('logoutCtrl', function($scope, $http, User, $location, $route) {
    $http.get(host + "/api/registered/logout")
    .then(function (response) {
        console.log(response.data)
        if(response.data.success == true){
            User.username = ""
            User.privilege = 0
            $location.path('/');
            //$route.reload()
        }
    });
});

app.controller('candidatesCtrl', function($scope, $http, $location) {
    $scope.create_candidate = function(){
        $http.post(host + "/api/privileged/newCandidate", {
            'candidate_name': $scope.candidate_name
        })
        .then(function(response) {
            if(response.data.success == true){
                //$location.path('/');
                $scope.message = response.data.message 
                console.log(response.data) 
            } else {
                console.log(response.data)
            }
        }, function(error) {
            console.log('Error:')
            console.log(error)
        })
    }
});

app.controller('usersCtrl', function($scope, $http) {
    $http.get(host + "/api/privileged/listUsers")
    .then(function (response) {
    	console.log(response.data)
    	if(response.data.success !== false){
    		$scope.users = response.data;
    	}
    });
});

app.controller('registerCtrl', function($scope, $http, $route, $location, User) {
    $scope.register = function(){
    	$http.post(host + "/api/newUser", {
    		'username': $scope.username
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	       		User.username = $scope.username
                console.log(response.data)
                User.privilege = response.data.privilege
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});

app.controller("loginCtrl", function ($scope, $http, $route, $location, User) {
    $scope.login = function(){
    	$http.post(host + "/api/login", {
    		'username': $scope.username,
    		'password': $scope.password == undefined ? "" : $scope.password
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	        	User.username = $scope.username
                User.privilege = response.data.privilege
                console.log(response.data)
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});
app.controller("voteCtrl", function ($scope, $http, User) {

    var getVotes = function(){
        $http.get(host + "/api/registered/listCandidates")
        .then(function (response) {
            console.log(response.data)
            if(response.data.success !== false){
                $scope.candidates = response.data;
            }
        });
    }

    var getPointsRemaining = function(){
        $http.get(host + "/api/registered/pointsRemaining")
        .then(function (response) {
            console.log(response.data)
            if(response.data.success !== false){
                $scope.pointsRemaining = response.data.points;
            } else {
                $scope.pointsRemaining = 0;
            }
        });
    }

    Pusher.logToConsole = true;
    var channel = pusher.subscribe('upvote-channel');
    channel.bind('upvote-event', function(data) {
      getVotes()
    });

    getPointsRemaining()
    $scope.orderByField = 'points';
    $scope.reverseSort = true;

    $scope.username = User.username
    getVotes()

    $scope.upvote = function(id){
        console.log(id.x._id)
        $http.post(host + "/api/registered/upvote", {
            'id': id.x._id
        })
        .then(function(response) {
            if(response.data.success == true){
                console.log(response.data.points) 
                id.x.points = id.x.points + 1
            } else {
                console.log(response.data.message) 
            }
            console.log(response.data)
        }, function(error) {
            console.log('Error:')
            console.log(error)
        })
        getPointsRemaining()
    }
});

</script>

</body>
</html>