<!DOCTYPE html>
<html lang="en-US">
<head>
<link rel="stylesheet" type="text/css" href="https://opensource.keycdn.com/fontawesome/4.7.0/font-awesome.min.css" />
</head>
<style>
table, th , td  {
  border: 1px solid grey;
  border-collapse: collapse;
  padding: 5px;
}
table tr:nth-child(odd) {
  background-color: #f1f1f1;
}
table tr:nth-child(even) {
  background-color: #ffffff;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.js"></script>

<body>

<div ng-app="myApp">

<!--<table>
  <tr ng-repeat="x in names">
    <td>{{ x.name }}</td>
    <td>{{ x.points }}</td>
  </tr>
</table>-->

<a href="#/">Main</a>
<a href="#login">Login</a>
<a href="#vote">Vote</a>
<a href="#users">Users</a>
<a href="#register">Register</a>

<div ng-view></div>

</div>

<script>
host = "http://localhost:3000"
var app = angular.module('myApp', ["ngRoute"]);

// Create the factory that share the Fact
app.factory('User', function(){
  return { username: '' };
});

app.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "main.htm",
        controller : "candidatesCtrl"
    })
    .when("/login", {
        templateUrl : "login.htm",
        controller : "loginCtrl"
    })
    .when("/vote", {
        templateUrl : "vote.htm",
        controller : "voteCtrl"
    })
    .when("/users", {
        templateUrl : "users.htm",
        controller : "usersCtrl"
    })
    .when("/register", {
        templateUrl : "register.htm",
        controller : "registerCtrl"
    })
});

app.controller('candidatesCtrl', function($scope, $http, User, $route) {
	$scope.username = User.username
    $http.get(host + "/api/registered/listCandidates")
    .then(function (response) {
    	console.log(response.data)
    	if(response.data.success !== false){
    		$scope.candidates = response.data;
    	}
    });

    $scope.upvote = function(id){
    	console.log(id.x._id)
    	$http.post(host + "/api/registered/upvote", {
    		'id': id.x._id
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	       		console.log(response.data.points) 
	       		id.x.points = id.x.points + 1
	        } else {
	        	console.log(response.data.message) 
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});

app.controller('usersCtrl', function($scope, $http) {
    $http.get(host + "/api/privileged/listUsers")
    .then(function (response) {
    	console.log(response.data)
    	if(response.data.success !== false){
    		$scope.users = response.data;
    	}
    });
});

app.controller('registerCtrl', function($scope, $http, $route, $location, User) {
    $scope.register = function(){
    	$http.post(host + "/api/newUser", {
    		'username': $scope.username
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	       		User.username = $scope.username
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});

app.controller("loginCtrl", function ($scope, $http, $route, $location, User) {
    $scope.login = function(){
    	$http.post(host + "/api/login", {
    		'username': $scope.username,
    		'password': $scope.password == undefined ? "" : $scope.password
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	        	User.username = $scope.username
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});
app.controller("voteCtrl", function ($scope) {
    $scope.msg = "I love Paris";
});

</script>

</body>
</html>