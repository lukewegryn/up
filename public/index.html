<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="stylesheet" type="text/css" href="css/fontawesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="css/fontawesome/font-awesome-animation.css">
    <link rel="stylesheet" href="css/template_mods.css">
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
</head>
<script src="js/angularjs/1.4.8/angular.min.js"></script>
<script src="js/angularjs/1.4.8/angular-touch.js"></script>
<script src="js/angularjs/1.4.8/angular-animate.js"></script>
<script src="js/angularjs/1.4.8/angular-route.js"></script>
<script src="js/angularjs/ui-bootstrap-tpls-2.5.0.min.js"></script>
<script src="js/pusher/pusher.min.js"></script>

<body>

<div ng-app="myApp">

<!--<table>
  <tr ng-repeat="x in names">
    <td>{{ x.name }}</td>
    <td>{{ x.points }}</td>
  </tr>
</table>-->

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div ng-controller="navCtrl" class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#/">UP</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#/">Main</a></li>
        <li><a ng-show="!isRegistered()" href="#login">Login</a></li>
        <li><a ng-show="isRegistered()" href="#vote">Vote</a></li>
        <li><a ng-show="isPrivileged()" href="#users">Users</a></li>
        <li><a ng-show="!isRegistered()" href="#register">Register</a></li>
        <li><a ng-show="isRegistered()" href="#candidates">Candidates</a></li>
        <li><a ng-show="isRegistered()" href="#logout">Logout</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<!--<div ng-controller="navCtrl">
    <a href="#/">Main</a>
    <a ng-show="!isRegistered()" href="#login">Login</a>
    <a ng-show="isRegistered()" href="#vote">Vote</a>
    <a ng-show="isPrivileged()" href="#users">Users</a>
    <a ng-show="!isRegistered()" href="#register">Register</a>
    <a ng-show="isPrivileged()" href="#candidates">Candidates</a>
    <a ng-show="isRegistered()" href="#logout">Logout</a>
</div>-->

<div class="container">
    <div ng-view></div>
</div>

</div>

<script>
host = "http://ec2-34-206-3-241.compute-1.amazonaws.com" <!--"http://localhost:3000"-->
var pusher = new Pusher('ba3b3cba4d81f78b5a20', {
  encrypted: true
});

    // Enable pusher logging - don't include this in production

var app = angular.module('myApp', ["ngRoute", 'ui.bootstrap', 'ngAnimate']);

// Create the factory that share the Fact
app.factory('User', function(){
  return { username: '', privilege: 0 };
});

app.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "main.htm",
        controller : "mainCtrl"
    })
    .when("/login", {
        templateUrl : "login.htm",
        controller : "loginCtrl"
    })
    .when("/vote", {
        templateUrl : "vote.htm",
        controller : "voteCtrl"
    })
    .when("/users", {
        templateUrl : "users.htm",
        controller : "usersCtrl"
    })
    .when("/register", {
        templateUrl : "register.htm",
        controller : "registerCtrl"
    })
    .when("/candidates", {
        templateUrl : "candidates.htm",
        controller : "candidatesCtrl"
    })
    .when("/logout", {
        template : "<h3>You have been logged out.</h3>",
        controller : "logoutCtrl"
    })
});

app.controller('navCtrl', function($scope, $http, User) {

    $http.get(host + "/api/currentPrivilege")
    .then(function (response) {
        if(response.data.success !== false){
            console.log("Reloading navCtrl...")
            console.log(response.data)
            User.privilege = response.data.privilege;
            User.username = response.data.username;
        }
    });

    $scope.isRegistered = function(status) {
        if(User.privilege == 1 || User.privilege == 2){
            return true
        } else {
            return false
        }
    };
    $scope.isPrivileged = function(status) {
        if(User.privilege == 1){
            return true
        } else {
            return false
        }
    };
});

app.controller('mainCtrl', function($scope, $http, User, $route) {

});

app.controller('candidateModalCtrl', function($scope, $http, $route, $uibModal, $log, $document){
  var $ctrl = this;
  $ctrl.items = ['item1', 'item2', 'item3'];

  $ctrl.animationsEnabled = true;

  $ctrl.open = function (size, parentSelector) {
    var parentElem = parentSelector ? 
      angular.element($document[0].querySelector('.modal-demo ' + parentSelector)) : undefined;
    var modalInstance = $uibModal.open({
      animation: $ctrl.animationsEnabled,
      ariaLabelledBy: 'modal-title',
      ariaDescribedBy: 'modal-body',
      templateUrl: 'candidate_modal.htm',
      controller: 'candidateModalCtrl',
      controllerAs: '$ctrl',
      size: size,
      appendTo: parentElem,
      resolve: {
        items: function () {
          return $ctrl.items;
        }
      }
    });

    modalInstance.result.then(function (selectedItem) {
      $ctrl.selected = selectedItem;
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  };

  $ctrl.openComponentModal = function () {
    var modalInstance = $uibModal.open({
      animation: $ctrl.animationsEnabled,
      component: 'modalComponent',
      resolve: {
        items: function () {
          return $ctrl.items;
        }
      }
    });

    modalInstance.result.then(function (selectedItem) {
      $ctrl.selected = selectedItem;
    }, function () {
      $log.info('modal-component dismissed at: ' + new Date());
    });
  };

  $ctrl.openMultipleModals = function () {
    $uibModal.open({
      animation: $ctrl.animationsEnabled,
      ariaLabelledBy: 'modal-title-bottom',
      ariaDescribedBy: 'modal-body-bottom',
      templateUrl: 'stackedModal.html',
      size: 'sm',
      controller: function($scope) {
        $scope.name = 'bottom';  
      }
    });

    $uibModal.open({
      animation: $ctrl.animationsEnabled,
      ariaLabelledBy: 'modal-title-top',
      ariaDescribedBy: 'modal-body-top',
      templateUrl: 'stackedModal.html',
      size: 'sm',
      controller: function($scope) {
        $scope.name = 'top';  
      }
    });
  };

  $ctrl.toggleAnimation = function () {
    $ctrl.animationsEnabled = !$ctrl.animationsEnabled;
  };
});

// Please note that $uibModalInstance represents a modal window (instance) dependency.
// It is not the same as the $uibModal service used above.

angular.module('ui.bootstrap.demo').controller('ModalInstanceCtrl', function ($uibModalInstance, items) {
  var $ctrl = this;
  $ctrl.items = items;
  $ctrl.selected = {
    item: $ctrl.items[0]
  };

  $ctrl.ok = function () {
    $uibModalInstance.close($ctrl.selected.item);
  };

  $ctrl.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
}

app.controller('logoutCtrl', function($scope, $http, User, $location, $route) {
    $http.get(host + "/api/registered/logout")
    .then(function (response) {
        console.log(response.data)
        if(response.data.success == true){
            User.username = ""
            User.privilege = 0
            $location.path('/');
            //$route.reload()
        }
    });
});

app.controller('candidatesCtrl', function($scope, $http, $location) {
    $scope.create_candidate = function(){
        $http.post(host + "/api/registered/newCandidate", {
            'candidate_name': $scope.candidate_name
        })
        .then(function(response) {
            if(response.data.success == true){
                //$location.path('/');
                $scope.message = response.data.message 
                console.log(response.data) 
            } else {
                console.log(response.data)
            }
        }, function(error) {
            console.log('Error:')
            console.log(error)
        })
    }
});

app.controller('usersCtrl', function($scope, $http) {
    $http.get(host + "/api/privileged/listUsers")
    .then(function (response) {
    	console.log(response.data)
    	if(response.data.success !== false){
    		$scope.users = response.data;
    	}
    });
});

app.controller('registerCtrl', function($scope, $http, $route, $location, User) {
    $scope.register = function(){
    	$http.post(host + "/api/newUser", {
    		'username': $scope.username
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	       		User.username = $scope.username
                console.log(response.data)
                User.privilege = response.data.privilege
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});

app.controller("loginCtrl", function ($scope, $http, $route, $location, User) {
    $scope.login = function(){
        //alert(1);
    	$http.post(host + "/api/login", {
    		'username': $scope.username,
    		'password': $scope.password == undefined ? "" : $scope.password
    	})
	    .then(function(response) {
	        if(response.data.success == true){
	        	User.username = $scope.username
                User.privilege = response.data.privilege
                console.log(response.data)
	        	$location.path('/');  
	        } else {
	        	$scope.message = response.data.message
	        }
	        console.log(response.data)
	    }, function(error) {
		    console.log('Error:')
		    console.log(error)
		})
    }
});
app.controller("voteCtrl", function ($scope, $http, User) {

    var getVotes = function(){
        $http.get(host + "/api/registered/listCandidates")
        .then(function (response) {
            console.log(response.data)
            if(response.data.success !== false){
                $scope.candidates = response.data;
            }
        });
    }

    var getPointsRemaining = function(){
        $http.get(host + "/api/registered/pointsRemaining")
        .then(function (response) {
            console.log(response.data)
            if(response.data.success !== false){
                $scope.pointsRemaining = response.data.points;
            } else {
                $scope.pointsRemaining = 0;
            }
        });
    }

    Pusher.logToConsole = true;
    var channel = pusher.subscribe('upvote-channel');
    channel.bind('upvote-event', function(data) {
      getVotes()
    });

    getPointsRemaining()
    $scope.orderByField = 'points';
    $scope.reverseSort = true;

    $scope.username = User.username
    getVotes()

    $scope.upvote = function(id){
        console.log(id.x._id)
        $http.post(host + "/api/registered/upvote", {
            'id': id.x._id
        })
        .then(function(response) {
            if(response.data.success == true){
                console.log(response.data.points) 
                id.x.points = id.x.points + 1
                getPointsRemaining()
            } else {
                $scope.message = response.data.message
            }
            console.log(response.data)
        }, function(error) {
            console.log('Error:')
            console.log(error)
        })
    }
});

</script>
<script src="js/jquery/jquery.min.js"></script>
<script src="js/bootstrap/bootstrap.min.js"></script>
<script>
<!--JQUERY functions-->
$('.nav a').click(function(){
    $('.navbar-collapse').collapse('hide');
});
$('.nav.navbar-nav > li').on('click', function(e) {
    $('.nav.navbar-nav > li').removeClass('active');
    $(this).addClass('active');
});    
</script>
</body>
</html>